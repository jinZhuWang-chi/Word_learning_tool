<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½å•è¯å­¦ä¹ ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans SC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .content {
      padding: 40px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.quick-start {
      cursor: pointer;
      border: 2px dashed #667eea;
      background: #f8fafc;
    }
    
    .stat-card.quick-start:hover {
      background: #f1f5f9;
      border-color: #764ba2;
    }
    
    .stat-card.quick-start .stat-value {
      color: #667eea;
      font-size: 40px; /* ç¨å°ä¸€ç‚¹ä»¥å®¹çº³å›¾æ ‡ */
    }

    .stat-card.blue { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); }
    .stat-card.red { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
    .stat-card.yellow { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
    .stat-card.green { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); }

    .stat-value {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-card.blue .stat-value { color: #0284c7; }
    .stat-card.red .stat-value { color: #dc2626; }
    .stat-card.yellow .stat-value { color: #d97706; }
    .stat-card.green .stat-value { color: #059669; }

    .stat-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 500;
    }

    .section {
      margin-bottom: 40px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 15px;
      color: #1e293b;
    }

    .section-desc {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 15px;
      line-height: 1.6;
    }

    textarea {
      width: 100%;
      height: 200px;
      padding: 20px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      resize: none;
      transition: border-color 0.3s ease;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    button {
      flex: 1;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
      background: #94a3b8;
    }
    
    button:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:disabled {
      background: linear-gradient(135deg, #a3b3f3 0%, #a48cb9 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #475569;
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn-danger {
      background: #fecaca;
      color: #dc2626;
    }

    .mode-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .mode-card {
      padding: 40px;
      border: 3px solid #e2e8f0;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .mode-card:hover {
      border-color: #667eea;
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
    }

    .mode-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .mode-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #1e293b;
    }

    .mode-desc {
      font-size: 14px;
      color: #64748b;
    }

    .practice-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 10px;
      margin-bottom: 30px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }

    .stats-row {
      display: flex;
      justify-content: space-around;
      background: #f8fafc;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-item-label {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 8px;
    }

    .stat-item-value {
      font-size: 32px;
      font-weight: 700;
    }

    .stat-item-value.purple { color: #667eea; }
    .stat-item-value.green { color: #10b981; }
    .stat-item-value.red { color: #ef4444; }

    .question-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      padding: 50px 40px;
      border-radius: 15px;
      margin-bottom: 30px;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .audio-btn {
      margin: 0 auto 30px;
      padding: 20px 40px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .audio-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
    }

    .prompt-text {
      font-size: 48px;
      font-weight: 700;
      text-align: center;
      color: #1e293b;
      margin-bottom: 30px;
    }

    .feedback {
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .feedback.correct {
      background: #d1fae5;
      color: #059669;
    }

    .feedback.incorrect {
      background: #fee2e2;
      color: #dc2626;
    }

    input[type="text"], input[type="search"] {
      width: 100%;
      padding: 20px;
      font-size: 20px;
      border: 3px solid #e2e8f0;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    input[type="text"]:focus, input[type="search"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    input[type="search"] {
      font-size: 16px;
      padding: 15px 20px;
      margin-bottom: 10px;
    }

    input[type="text"].correct {
      border-color: #10b981;
      background: #f0fdf4;
    }

    input[type="text"].incorrect {
      border-color: #ef4444;
      background: #fef2f2;
    }

    .hint-text {
      text-align: center;
      color: #64748b;
      font-size: 14px;
      margin-top: 15px;
    }

    .complete-container {
      text-align: center;
      padding: 40px 20px;
    }

    .complete-title {
      font-size: 48px;
      font-weight: 700;
      color: #10b981;
      margin-bottom: 40px;
    }

    .complete-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .complete-stat-card {
      background: #f8fafc;
      padding: 40px 20px;
      border-radius: 15px;
    }

    .complete-stat-value {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .complete-stat-value.purple { color: #667eea; }
    .complete-stat-value.green { color: #10b981; }

    .complete-stat-label {
      font-size: 14px;
      color: #64748b;
    }

    .footer {
      text-align: center;
      color: white;
      opacity: 0.8;
      font-size: 12px;
      margin-top: 30px;
    }

    .btn-small {
      flex: 0 0 auto;
      padding: 16px 30px;
    }

    .curve-chart {
      background: #f8fafc;
      padding: 30px;
      border-radius: 15px;
      margin-top: 30px;
    }

    .curve-title {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 20px;
      text-align: center;
    }

    .curve-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      background: white;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .curve-word {
      font-weight: 600;
      color: #1e293b;
    }

    .curve-info {
      display: flex;
      gap: 20px;
      font-size: 12px;
      color: #64748b;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }
    
    /* å­¦ä¹ æ›²çº¿å¯è§†åŒ– */
    .difficulty-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .difficulty-easy { background: #d1fae5; color: #059669; }
    .difficulty-medium { background: #fef3c7; color: #d97706; }
    .difficulty-hard { background: #fee2e2; color: #dc2626; }

    .word-list {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .word-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border-radius: 10px;
      margin-bottom: 10px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    
    .word-item.is-due {
      background: #fef2f2;
      border-color: #fecaca;
    }

    .word-item:hover {
      border-color: #667eea;
      background: #f8fafc;
    }
    
    .word-star {
      font-size: 22px;
      cursor: pointer;
      color: #cbd5e1;
      transition: color 0.2s, transform 0.2s;
    }
    
    .word-star.starred {
      color: #f59e0b;
    }
    
    .word-star:hover {
      transform: scale(1.2);
    }
    
    .word-main {
      flex: 1;
      margin: 0 15px;
    }

    .word-english {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 5px;
    }

    .word-chinese {
      font-size: 14px;
      color: #64748b;
    }

    .word-stats {
      display: flex;
      gap: 15px;
      align-items: center;
      font-size: 12px;
      color: #64748b;
    }
    
    /* ç»ƒä¹ è®¾ç½®é¡µé¢ */
    .settings-container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .setting-card {
      padding: 20px;
      border: 3px solid #e2e8f0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8fafc;
    }
    
    .setting-card:hover {
      background: #f1f5f9;
    }
    
    .setting-card.active {
      border-color: #667eea;
      background: #f0f2fe;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
    }
    
    .setting-card-title {
      font-size: 16px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 5px;
    }
    
    .setting-card-desc {
      font-size: 12px;
      color: #64748b;
    }
    
    .setting-card-count {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
      margin-top: 10px;
    }
    
    .slider-container {
      background: #f8fafc;
      padding: 30px;
      border-radius: 12px;
      margin-top: 30px;
    }
    
    .slider-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 20px;
    }
    
    .slider-value {
      font-size: 24px;
      color: #667eea;
      font-weight: 700;
    }
    
    input[type="range"] {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 5px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      background: #667eea;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      background: #764ba2;
    }
    
    .warning-text {
      color: #d97706;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      margin-top: 15px;
    }
    
    /* æ™ºèƒ½æç¤º */
    .smart-hint {
      background: #f8fafc;
      padding: 30px;
      border-radius: 15px;
      margin-top: 30px;
      margin-bottom: 30px;
      border-left: 5px solid #667eea;
    }
    
    .smart-hint-title {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 15px;
    }
    
    .smart-hint-text {
      font-size: 16px;
      color: #475569;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }

      .header h1 {
        font-size: 28px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .stat-value {
        font-size: 36px;
      }
      
      .stat-card.quick-start .stat-value {
        font-size: 32px;
      }

      .prompt-text {
        font-size: 32px;
      }

      .mode-grid {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      button {
        width: 100%;
      }
      
      .settings-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .word-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .word-star {
        position: absolute;
        top: 15px;
        right: 15px;
      }
      
      .word-main {
        margin: 0;
        margin-right: 30px; /* ä¸ºæ˜Ÿæ ‡ç•™å‡ºç©ºé—´ */
      }
      
      .word-stats {
        margin-top: 10px;
        gap: 10px;
        flex-wrap: wrap;
      }
      
      .curve-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .curve-info {
        margin-top: 10px;
        gap: 10px;
        flex-wrap: wrap;
      }
    }

  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ==================== FSRS ç®—æ³•ï¼ˆå®Œæ•´ç‰ˆï¼‰====================
    class FSRS {
      constructor() {
        // FSRS-4.5 ä¼˜åŒ–å‚æ•°
        this.w = [0.4, 0.6, 2.4, 5.8, 4.93, 0.94, 0.86, 0.01, 1.49, 0.14, 0.94, 2.18, 0.05, 0.34, 1.26, 0.29, 2.61];
      }

      // åˆå§‹éš¾åº¦è®¡ç®—
      initDifficulty(rating) {
        const d = this.w[4] - Math.exp(this.w[5] * (rating - 1)) + 1;
        return this.constrainDifficulty(d);
      }

      // åˆå§‹ç¨³å®šæ€§è®¡ç®—
      initStability(rating) {
        return Math.max(this.w[rating - 1], 0.1);
      }

      // ä¸‹æ¬¡ç¨³å®šæ€§è®¡ç®—
      nextStability(d, s, r, rating) {
        const hardPenalty = rating === 2 ? this.w[15] : 1;
        const easyBonus = rating === 4 ? this.w[16] : 1;
        
        const newS = s * (
          Math.exp(this.w[8]) * (11 - d) * Math.pow(s, -this.w[9]) *
          (Math.exp((1 - r) * this.w[10]) - 1) * hardPenalty * easyBonus + 1
        );
        
        return Math.max(newS, 0.1);
      }

      // ä¸‹æ¬¡éš¾åº¦è®¡ç®—
      nextDifficulty(d, rating) {
        const nextD = d - this.w[6] * (rating - 3);
        return this.constrainDifficulty(nextD);
      }

      // é™åˆ¶éš¾åº¦èŒƒå›´
      constrainDifficulty(d) {
        return Math.min(Math.max(d, 1), 10);
      }

      // é—å¿˜æ›²çº¿ï¼ˆå¯æå–æ€§è®¡ç®—ï¼‰
      forgettingCurve(elapsedDays, stability) {
        return Math.pow(1 + elapsedDays / (9 * stability), -1);
      }

      // è®¡ç®—ä¸‹æ¬¡å¤ä¹ é—´éš”
      nextInterval(stability, requestedRetention = 0.9) {
        const interval = stability * 9 * (1 / requestedRetention - 1);
        return Math.max(1, Math.round(interval));
      }

      // è·å–éš¾åº¦ç­‰çº§æè¿°
      getDifficultyLevel(difficulty) {
        if (difficulty <= 3) return 'easy';
        if (difficulty <= 7) return 'medium';
        return 'hard';
      }

      // æ›´æ–°å•è¯çŠ¶æ€ï¼ˆå®Œæ•´ç‰ˆï¼‰
      updateWord(word, rating) {
        const now = Date.now();
        const newWord = { ...word };

        // é¦–æ¬¡å­¦ä¹ 
        if (newWord.reps === 0) {
          newWord.difficulty = this.initDifficulty(rating);
          newWord.stability = this.initStability(rating);
          newWord.retrievability = 1;
        } else {
          // è®¡ç®—ç»è¿‡çš„å¤©æ•°
          const elapsedDays = newWord.last_review 
            ? (now - newWord.last_review) / (1000 * 60 * 60 * 24) 
            : 0;
          
          // æ›´æ–°å¯æå–æ€§
          newWord.retrievability = this.forgettingCurve(elapsedDays, newWord.stability);
          
          // æ›´æ–°éš¾åº¦
          newWord.difficulty = this.nextDifficulty(newWord.difficulty, rating);
          
          // æ›´æ–°ç¨³å®šæ€§
          newWord.stability = this.nextStability(
            newWord.difficulty, 
            newWord.stability, 
            newWord.retrievability, 
            rating
          );
        }

        // æ›´æ–°åŸºæœ¬ç»Ÿè®¡
        newWord.reps += 1;
        if (rating === 1) {
          newWord.lapses += 1;
        }
        newWord.last_review = now;
        newWord.state = this.getWordState(newWord.reps, rating);

        // è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¶é—´
        const intervalDays = this.nextInterval(newWord.stability);
        newWord.due = now + intervalDays * 24 * 60 * 60 * 1000;
        newWord.interval = intervalDays;

        return newWord;
      }

      // è·å–å•è¯çŠ¶æ€
      getWordState(reps, lastRating) {
        if (reps === 0) return 'new';
        if (reps < 3) return 'learning';
        if (reps >= 10 && lastRating >= 3) return 'mastered';
        return 'reviewing';
      }
    }

    // ==================== ä¸»åº”ç”¨ï¼ˆå®Œæ•´ç‰ˆï¼‰====================
    class VocabularyApp {
      constructor() {
        this.fsrs = new FSRS();
        this.library = [];
        this.dueWords = [];
        this.stage = 'library'; // 'library', 'settings', 'mode', 'practice', 'complete'
        this.currentMode = 0;
        this.currentIndex = 0;
        this.answer = '';
        this.feedback = null;
        this.isAnswered = false;
        this.stats = { correct: 0, incorrect: 0 };
        this.updatedWords = [];
        this.finalStats = null;
        this.searchTerm = '';
        
        // æ–°å¢ï¼šç»ƒä¹ è®¾ç½®
        this.practiceSettings = {
          filter: 'due', // 'due', 'all', 'new', 'hard', 'starred'
          sort: 'smart',   // 'smart', 'random', 'added', 'newFirst', 'errorFirst'
          quantity: 20
        };
        
        this.loadLibrary();
        this.render();
      }

      // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è¯åº“
      loadLibrary() {
        try {
          const stored = localStorage.getItem('wordLibrary_v2');
          if (stored) {
            const parsed = JSON.parse(stored);
            if (Array.isArray(parsed)) {
              // ç¡®ä¿æ‰€æœ‰å•è¯éƒ½æœ‰å¿…éœ€å­—æ®µ
              this.library = parsed.map(w => ({
                english: w.english || '',
                chinese: Array.isArray(w.chinese) ? w.chinese : [w.chinese || ''],
                difficulty: w.difficulty || 5,
                stability: w.stability || 0.1,
                reps: w.reps || 0,
                lapses: w.lapses || 0,
                last_review: w.last_review || null,
                due: w.due || Date.now(),
                retrievability: w.retrievability || 0,
                state: w.state || 'new',
                interval: w.interval || 0,
                isStarred: w.isStarred || false // æ–°å¢ï¼šæ”¶è—çŠ¶æ€
              }));
            }
          }
        } catch (e) {
          console.error('Load error:', e);
          localStorage.removeItem('wordLibrary_v2');
        }
      }

      // ä¿å­˜è¯åº“åˆ°æœ¬åœ°å­˜å‚¨
      saveLibrary() {
        try {
          localStorage.setItem('wordLibrary_v2', JSON.stringify(this.library));
        } catch (e) {
          console.error('Save error:', e);
          alert('ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³ï¼');
        }
      }

      // æ·»åŠ å•è¯
      addWords(text) {
        if (!text || !text.trim()) {
          alert('è¯·è¾“å…¥å•è¯ï¼');
          return;
        }

        const lines = text.trim().split('\n');
        const newWords = [];
        const now = Date.now();
        let duplicates = 0;

        lines.forEach(raw => {
          const line = raw.trim();
          if (!line) return;

          const parts = line.split(/\s+/);
          if (parts.length < 2) return;

          const english = parts[0].toLowerCase();
          const chinese = parts.slice(1).join(' ');
          const translations = chinese.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t);

          if (!english || translations.length === 0) return;

          const exists = this.library.find(w => w.english === english);
          if (!exists) {
            newWords.push({
              english,
              chinese: translations,
              difficulty: 5,
              stability: 0.1,
              reps: 0,
              lapses: 0,
              last_review: null,
              due: now,
              retrievability: 0,
              state: 'new',
              interval: 0,
              isStarred: false // æ–°å¢
            });
          } else {
            duplicates++;
          }
        });

        if (newWords.length > 0) {
          this.library = [...this.library, ...newWords];
          this.saveLibrary();
          let msg = `æˆåŠŸæ·»åŠ  ${newWords.length} ä¸ªæ–°å•è¯ï¼`;
          if (duplicates > 0) {
            msg += `\nè·³è¿‡ ${duplicates} ä¸ªé‡å¤å•è¯ã€‚`;
          }
          alert(msg);
          this.render();
        } else {
          alert(duplicates > 0 ? `æ‰€æœ‰å•è¯éƒ½å·²å­˜åœ¨ï¼` : 'æ²¡æœ‰æœ‰æ•ˆçš„å•è¯æ ¼å¼ï¼');
        }
      }
      
      // æ–°å¢ï¼šåˆ‡æ¢æ”¶è—çŠ¶æ€
      toggleStar(english) {
        const word = this.library.find(w => w.english === english);
        if (word) {
          word.isStarred = !word.isStarred;
          this.saveLibrary();
          this.render(); // ç«‹å³åˆ·æ–°UI
        }
      }

      // è¿›å…¥ç»ƒä¹ è®¾ç½®é¡µé¢
      startPractice() {
        if (this.library.length === 0) {
          alert('è¯åº“ä¸ºç©ºï¼è¯·å…ˆæ·»åŠ å•è¯ã€‚');
          return;
        }
        
        // é‡ç½®ä¸ºé»˜è®¤â€œå¾…å¤ä¹ â€
        this.practiceSettings.filter = 'due';
        this.practiceSettings.sort = 'smart';
        
        this.stage = 'settings'; // æ–°å¢ï¼šè¿›å…¥è®¾ç½®é˜¶æ®µ
        this.render();
      }
      
      // æ–°å¢ï¼šå¿«æ·ç»ƒä¹ 
      startQuickPractice(filter) {
        const words = this.getFilteredWords(filter);
        if (words.length === 0) {
          alert(`æš‚æ— ${filter === 'new' ? 'æ–°' : 'æ”¶è—çš„'}å•è¯ï¼`);
          return;
        }
        
        // ä½¿ç”¨æ™ºèƒ½æ’åºï¼Œæœ€å¤š20ä¸ª
        this.dueWords = this.getSortedWords(words, 'smart').slice(0, 20);
        this.stage = 'mode';
        this.render();
      }
      
      // æ–°å¢ï¼šæ ¹æ®è®¾ç½®å¼€å§‹ç»ƒä¹ 
      startConfiguredPractice() {
        let filtered = this.getFilteredWords(this.practiceSettings.filter);
        if (filtered.length === 0) {
          alert('å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å¯ç»ƒä¹ çš„å•è¯ï¼');
          return;
        }
        
        let sorted = this.getSortedWords(filtered, this.practiceSettings.sort);
        
        this.dueWords = sorted.slice(0, this.practiceSettings.quantity);
        this.stage = 'mode';
        this.render();
      }

      // é€‰æ‹©ç»ƒä¹ æ¨¡å¼
      selectMode(mode) {
        this.currentMode = mode;
        this.currentIndex = 0;
        this.answer = '';
        this.feedback = null;
        this.isAnswered = false;
        this.stats = { correct: 0, incorrect: 0 };
        this.updatedWords = JSON.parse(JSON.stringify(this.dueWords)); // æ·±æ‹·è´
        this.stage = 'practice';
        this.render();
        
        setTimeout(() => {
          if (mode === 1 || mode === 3) {
            this.playAudio();
          }
          const input = document.getElementById('answerInput');
          if (input) input.focus();
        }, 300);
      }

      // æ’­æ”¾è¯­éŸ³
      playAudio() {
        const word = this.updatedWords[this.currentIndex];
        if (!word || !window.speechSynthesis) {
          console.warn('è¯­éŸ³åŠŸèƒ½ä¸å¯ç”¨');
          return;
        }
        
        try {
          window.speechSynthesis.cancel();
          const utter = new SpeechSynthesisUtterance(word.english);
          utter.lang = 'en-US';
          utter.rate = 0.85;
          utter.pitch = 1.0;
          utter.volume = 1.0;
          
          utter.onerror = (e) => {
            console.error('Speech error:', e);
          };
          
          window.speechSynthesis.speak(utter);
        } catch (e) {
          console.error('Speech error:', e);
        }
      }

      // æ£€æŸ¥ç­”æ¡ˆ
      checkAnswer() {
        if (this.isAnswered) {
          this.handleNext();
          return;
        }

        const text = this.answer.trim();
        if (!text) {
          alert('âš ï¸ è¯·è¾“å…¥ç­”æ¡ˆï¼');
          return;
        }

        const word = this.updatedWords[this.currentIndex];
        let isCorrect = false;
        let rating = 1;

        // æ¨¡å¼1ï¼šè‹±è¯‘ä¸­
        if (this.currentMode === 1) {
          isCorrect = word.chinese.some(t => {
            const normalized = text.toLowerCase().replace(/\s+/g, '');
            const target = t.toLowerCase().replace(/\s+/g, '');
            return normalized.includes(target) || target.includes(normalized);
          });
        } 
        // æ¨¡å¼2ï¼šä¸­è¯‘è‹±
        else if (this.currentMode === 2) {
          const normalized = text.toLowerCase().trim();
          isCorrect = normalized === word.english.toLowerCase();
        } 
        // æ¨¡å¼3ï¼šå¬å†™
        else if (this.currentMode === 3) {
          const parts = text.split(/\s+/);
          if (parts.length >= 2) {
            const answerEn = parts[0].toLowerCase().trim();
            const answerCn = parts.slice(1).join(' ').toLowerCase().replace(/\s+/g, '');
            
            const englishCorrect = answerEn === word.english.toLowerCase();
            const chineseCorrect = word.chinese.some(t => {
              const target = t.toLowerCase().replace(/\s+/g, '');
              return answerCn.includes(target) || target.includes(answerCn);
            });
            
            isCorrect = englishCorrect && chineseCorrect;
          }
        }

        // æ ¹æ®æ­£ç¡®ä¸å¦è®¾ç½®è¯„åˆ†
        if (isCorrect) {
          rating = 4; // Easy
          this.stats.correct += 1;
          this.feedback = { type: 'correct', text: 'âœ“ æ­£ç¡®ï¼å¾ˆæ£’ï¼' };
        } else {
          rating = 1; // Again
          this.stats.incorrect += 1;
          const correctAns = this.currentMode === 2 
            ? word.english 
            : this.currentMode === 3
              ? `${word.english} ${word.chinese.join('ï¼Œ')}`
              : word.chinese.join('ï¼Œ');
          this.feedback = { type: 'incorrect', text: `âœ— é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆï¼š${correctAns}` };
        }

        // ä½¿ç”¨FSRSæ›´æ–°å•è¯
        const updated = this.fsrs.updateWord(word, rating);
        this.updatedWords[this.currentIndex] = updated;
        this.isAnswered = true;
        this.render();

        // æ­£ç¡®ç­”æ¡ˆè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜
        if (isCorrect) {
          setTimeout(() => this.handleNext(), 1200);
        }
      }

      // å¤„ç†ä¸‹ä¸€é¢˜
      handleNext() {
        if (this.currentIndex + 1 >= this.updatedWords.length) {
          this.completePractice();
          return;
        }
        
        this.currentIndex += 1;
        this.answer = '';
        this.feedback = null;
        this.isAnswered = false;
        this.render();
        
        setTimeout(() => {
          if (this.currentMode === 1 || this.currentMode === 3) {
            this.playAudio();
          }
          const input = document.getElementById('answerInput');
          if (input) input.focus();
        }, 100);
      }

      // è·³è¿‡å½“å‰é¢˜ç›®
      skipQuestion() {
        const word = this.updatedWords[this.currentIndex];
        const updated = this.fsrs.updateWord(word, 1);
        this.updatedWords[this.currentIndex] = updated;
        this.stats.incorrect += 1;
        this.handleNext();
      }

      // å®Œæˆç»ƒä¹ 
      completePractice() {
        // æ›´æ–°è¯åº“
        this.library = this.library.map(w => {
          const updated = this.updatedWords.find(uw => uw.english === w.english);
          return updated || w;
        });
        this.saveLibrary();
        
        this.finalStats = { 
          ...this.stats, 
          total: this.updatedWords.length,
          accuracy: this.updatedWords.length > 0 
            ? Math.round((this.stats.correct / this.updatedWords.length) * 100)
            : 0
        };
        
        this.stage = 'complete';
        this.render();
      }

      // åˆ é™¤å•è¯
      deleteWord(english) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤å•è¯ã€Œ${english}ã€å—ï¼Ÿ`)) {
          return;
        }
        
        this.library = this.library.filter(w => w.english !== english);
        this.saveLibrary();
        this.render();
      }

      // é‡ç½®å•è¯è¿›åº¦
      resetWord(english) {
        if (!confirm(`ç¡®å®šè¦é‡ç½®å•è¯ã€Œ${english}ã€çš„å­¦ä¹ è¿›åº¦å—ï¼Ÿ`)) {
          return;
        }
        
        const now = Date.now();
        this.library = this.library.map(w => {
          if (w.english === english) {
            return {
              ...w,
              difficulty: 5,
              stability: 0.1,
              reps: 0,
              lapses: 0,
              last_review: null,
              due: now,
              retrievability: 0,
              state: 'new',
              interval: 0,
              isStarred: w.isStarred // ä¿ç•™æ”¶è—çŠ¶æ€
            };
          }
          return w;
        });
        this.saveLibrary();
        this.render();
      }

      // æ¸…ç©ºè¯åº“
      clearLibrary() {
        if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¯åº“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
          return;
        }
        
        if (!confirm('âš ï¸âš ï¸ å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰å•è¯å—ï¼Ÿ')) {
          return;
        }
        
        this.library = [];
        this.saveLibrary();
        this.render();
        alert('âœ“ è¯åº“å·²æ¸…ç©º');
      }

      // è·å–ç»Ÿè®¡æ•°æ®
      getStats() {
        const now = Date.now();
        return {
          total: this.library.length,
          due: this.library.filter(w => w.due <= now).length,
          learning: this.library.filter(w => w.state === 'learning').length,
          mastered: this.library.filter(w => w.state === 'mastered').length,
          new: this.library.filter(w => w.state === 'new').length,
          starred: this.library.filter(w => w.isStarred).length,
        };
      }
      
      // æ–°å¢ï¼šè·å–ç­›é€‰åçš„å•è¯
      getFilteredWords(filter) {
        const now = Date.now();
        switch (filter) {
          case 'due': return this.library.filter(w => w.due <= now);
          case 'new': return this.library.filter(w => w.state === 'new');
          case 'hard': return this.library.filter(w => w.difficulty >= 7);
          case 'starred': return this.library.filter(w => w.isStarred);
          case 'all': default: return [...this.library];
        }
      }

      // æ–°å¢ï¼šè·å–æ’åºåçš„å•è¯
      getSortedWords(words, sort) {
        const now = Date.now();
        let sorted = [...words];
        switch (sort) {
          case 'smart': // FSRS æ™ºèƒ½æ¨èï¼ˆæŒ‰é—å¿˜æ›²çº¿ï¼‰
            sorted.sort((a, b) => {
              const aR = a.last_review ? this.fsrs.forgettingCurve((now - a.last_review) / (1000 * 60 * 60 * 24), a.stability) : 0;
              const bR = b.last_review ? this.fsrs.forgettingCurve((now - b.last_review) / (1000 * 60 * 60 * 24), b.stability) : 0;
              return aR - bR; // å¯æå–æ€§è¶Šä½ï¼ˆè¶Šå®¹æ˜“å¿˜ï¼‰ï¼Œè¶Šé å‰
            });
            break;
          case 'random':
            sorted.sort(() => Math.random() - 0.5);
            break;
          case 'newFirst': // æ–°è¯ä¼˜å…ˆï¼ˆå¤ä¹ æ¬¡æ•°å°‘ï¼‰
            sorted.sort((a, b) => a.reps - b.reps);
            break;
          case 'errorFirst': // é”™è¯¯ä¼˜å…ˆï¼ˆé—å¿˜æ¬¡æ•°å¤šï¼‰
            sorted.sort((a, b) => b.lapses - a.lapses);
            break;
          case 'added': // æ·»åŠ é¡ºåº
            sorted.sort((a, b) => this.library.indexOf(a) - this.library.indexOf(b));
            break;
        }
        return sorted;
      }
      
      // æ–°å¢ï¼šè®¾ç½®ç»ƒä¹ ç­›é€‰
      selectFilter(filter) {
        this.practiceSettings.filter = filter;
        this.render();
      }
      
      // æ–°å¢ï¼šè®¾ç½®ç»ƒä¹ æ’åº
      selectSort(sort) {
        this.practiceSettings.sort = sort;
        this.render();
      }
      
      // æ–°å¢ï¼šè®¾ç½®ç»ƒä¹ æ•°é‡
      updateQuantity(value) {
        this.practiceSettings.quantity = parseInt(value, 10);
        this.render();
      }

      // å¯¼å‡ºè¯åº“
      exportLibrary() {
        if (this.library.length === 0) {
          alert('è¯åº“ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡ºï¼');
          return;
        }
        
        const data = JSON.stringify(this.library, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `vocabulary_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // å¯¼å…¥è¯åº“
      importLibrary() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const imported = JSON.parse(event.target.result);
              if (!Array.isArray(imported)) {
                throw new Error('Invalid format');
              }
              
              // åˆå¹¶è¯åº“ï¼Œé¿å…é‡å¤
              let added = 0;
              imported.forEach(word => {
                if (word.english && !this.library.find(w => w.english === word.english)) {
                  // å¯¼å…¥æ—¶ä¹Ÿç¡®ä¿æ–°å­—æ®µå­˜åœ¨
                  this.library.push({
                    english: word.english || '',
                    chinese: Array.isArray(word.chinese) ? word.chinese : [word.chinese || ''],
                    difficulty: word.difficulty || 5,
                    stability: word.stability || 0.1,
                    reps: word.reps || 0,
                    lapses: word.lapses || 0,
                    last_review: word.last_review || null,
                    due: word.due || Date.now(),
                    retrievability: word.retrievability || 0,
                    state: word.state || 'new',
                    interval: word.interval || 0,
                    isStarred: word.isStarred || false
                  });
                  added++;
                }
              });
              
              this.saveLibrary();
              alert(`âœ“ æˆåŠŸå¯¼å…¥ ${added} ä¸ªå•è¯ï¼`);
              this.render();
            } catch (err) {
              alert('âŒ å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼');
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }

      // ==================== æ¸²æŸ“éƒ¨åˆ† ====================
      
      render() {
        const app = document.getElementById('app');
        app.innerHTML = `
          <div class="container">
            <div class="card">
              ${this.renderHeader()}
              <div class="content">
                ${this.renderStage()}
              </div>
            </div>
            ${this.renderFooter()}
          </div>
        `;
        this.attachEventListeners();
      }

      renderHeader() {
        return `
          <div class="header">
            <h1>ğŸ¯ æ™ºèƒ½å•è¯å­¦ä¹ ç³»ç»Ÿ</h1>
            <p>åŸºäº FSRS ç®—æ³•çš„é«˜æ•ˆè®°å¿†åŠ©æ‰‹</p>
          </div>
        `;
      }

      renderFooter() {
        return `
          <div class="footer">
            ğŸ’¡ æç¤ºï¼šé¦–æ¬¡ä½¿ç”¨è¯·å…è®¸æµè§ˆå™¨çš„è¯­éŸ³æ’­æ”¾æƒé™ | FSRS Algorithm v4.5
          </div>
        `;
      }

      renderStage() {
        switch (this.stage) {
          case 'library': return this.renderLibrary();
          case 'settings': return this.renderSettings(); // æ–°å¢
          case 'mode': return this.renderModeSelect();
          case 'practice': return this.renderPractice();
          case 'complete': return this.renderComplete();
          default: return '<div class="loading">åŠ è½½ä¸­...</div>';
        }
      }

      renderLibrary() {
        const stats = this.getStats();
        return `
          <div>
            <div class="stats-grid">
              <div class="stat-card blue">
                <div class="stat-value">${stats.total}</div>
                <div class="stat-label">æ€»è¯æ±‡é‡</div>
              </div>
              <div class="stat-card red">
                <div class="stat-value">${stats.due}</div>
                <div class="stat-label">å¾…å¤ä¹ </div>
              </div>
              <div class="stat-card yellow">
                <div class="stat-value">${stats.learning}</div>
                <div class="stat-label">å­¦ä¹ ä¸­</div>
              </div>
              <div class="stat-card green">
                <div class="stat-value">${stats.mastered}</div>
                <div class="stat-label">å·²ç†Ÿç»ƒ</div>
              </div>
            </div>

            <div class="section">
              <h2 class="section-title">ğŸš€ å¿«æ·å¼€å§‹</h2>
              <div class="stats-grid">
                <div class="stat-card quick-start" id="quickStartNew">
                  <div class="stat-value">ğŸ†• ${stats.new}</div>
                  <div class="stat-label">ç»ƒä¹ æ–°å•è¯</div>
                </div>
                <div class="stat-card quick-start" id="quickStartStarred">
                  <div class="stat-value">â­ ${stats.starred}</div>
                  <div class="stat-label">ç»ƒä¹ æ”¶è—</div>
                </div>
              </div>
            </div>
            
            <div class="button-group" style="margin-bottom: 40px;">
              <button class="btn-primary" id="startPracticeBtn" ${stats.total === 0 ? 'disabled' : ''}>
                âš™ï¸ é…ç½®å¹¶å¼€å§‹å­¦ä¹  (${stats.due})
              </button>
            </div>

            <div class="section">
              <h2 class="section-title">ğŸ“ æ·»åŠ æ–°å•è¯</h2>
              <p class="section-desc">
                æ ¼å¼ï¼šè‹±æ–‡å•è¯ ä¸­æ–‡ç¿»è¯‘ï¼ˆå¤šä¸ªç¿»è¯‘ç”¨é€—å·åˆ†éš”ï¼‰<br>
                ç¤ºä¾‹ï¼šapple è‹¹æœ | important é‡è¦çš„,æœ‰é‡è¦æ„ä¹‰çš„
              </p>
              <textarea id="wordInput" placeholder="important é‡è¦çš„&#10;cool å‡‰çˆ½,å‡‰å¿«,å¾ˆé…·çš„&#10;exact ç²¾ç¡®çš„&#10;question é¢˜ç›®,é—®é¢˜&#10;many å¾ˆå¤š,å¤šç§&#10;school å­¦æ ¡,å­¦é™¢"></textarea>
              <div class="button-group">
                <button class="btn-primary" id="addWordsBtn">ğŸ“š æ·»åŠ åˆ°è¯åº“</button>
              </div>
            </div>

            <div class="section">
              <h2 class="section-title">ğŸ“š è¯åº“ç®¡ç†</h2>
              <div class="button-group">
                <button class="btn-secondary" id="exportBtn">ğŸ’¾ å¯¼å‡ºè¯åº“</button>
                <button class="btn-secondary" id="importBtn">ğŸ“‚ å¯¼å…¥è¯åº“</button>
                <button class="btn-danger" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©ºè¯åº“</button>
              </div>
            </div>

            ${this.renderWordList()}
          </div>
        `;
      }
      
      // æ–°å¢ï¼šæ¸²æŸ“ç»ƒä¹ è®¾ç½®é¡µé¢
      renderSettings() {
        const counts = {
          due: this.getFilteredWords('due').length,
          all: this.getFilteredWords('all').length,
          new: this.getFilteredWords('new').length,
          hard: this.getFilteredWords('hard').length,
          starred: this.getFilteredWords('starred').length,
        };
        
        const currentFilter = this.practiceSettings.filter;
        const currentSort = this.practiceSettings.sort;
        const currentQuantity = this.practiceSettings.quantity;
        const availableCount = counts[currentFilter];
        const isQuantityInvalid = currentQuantity > availableCount;
        const canStart = availableCount > 0;
        
        return `
          <div class="settings-container">
            <h2 class="section-title">1. ç­›é€‰ç»ƒä¹ å•è¯</h2>
            <p class="section-desc">é€‰æ‹©ä½ æœ¬æ¬¡æƒ³ç»ƒä¹ çš„å•è¯èŒƒå›´ã€‚</p>
            <div class="settings-grid">
              <div class="setting-card ${currentFilter === 'due' ? 'active' : ''}" onclick="app.selectFilter('due')">
                <div class="setting-card-title">ğŸ“… å¾…å¤ä¹ </div>
                <div class="setting-card-desc">åªç»ƒåˆ°æœŸå•è¯</div>
                <div class="setting-card-count">${counts.due}</div>
              </div>
              <div class="setting-card ${currentFilter === 'all' ? 'active' : ''}" onclick="app.selectFilter('all')">
                <div class="setting-card-title">ğŸ“š å…¨éƒ¨å•è¯</div>
                <div class="setting-card-desc">ç»ƒä¹ æ‰€æœ‰å•è¯</div>
                <div class="setting-card-count">${counts.all}</div>
              </div>
              <div class="setting-card ${currentFilter === 'new' ? 'active' : ''}" onclick="app.selectFilter('new')">
                <div class="setting-card-title">ğŸ†• æ–°å•è¯</div>
                <div class="setting-card-desc">åªç»ƒæ–°æ·»åŠ çš„</div>
                <div class="setting-card-count">${counts.new}</div>
              </div>
              <div class="setting-card ${currentFilter === 'hard' ? 'active' : ''}" onclick="app.selectFilter('hard')">
                <div class="setting-card-title">ğŸ”¥ å›°éš¾å•è¯</div>
                <div class="setting-card-desc">éš¾åº¦â‰¥7çš„å•è¯</div>
                <div class="setting-card-count">${counts.hard}</div>
              </div>
              <div class="setting-card ${currentFilter === 'starred' ? 'active' : ''}" onclick="app.selectFilter('starred')">
                <div class="setting-card-title">â­ æ”¶è—å•è¯</div>
                <div class="setting-card-desc">ä½ æ”¶è—çš„é‡ç‚¹</div>
                <div class="setting-card-count">${counts.starred}</div>
              </div>
            </div>
            
            <h2 class="section-title">2. æ™ºèƒ½æ’åº</h2>
            <p class="section-desc">é€‰æ‹©å•è¯å‡ºç°çš„é¡ºåºã€‚</p>
            <div class="settings-grid">
              <div class="setting-card ${currentSort === 'smart' ? 'active' : ''}" onclick="app.selectSort('smart')">
                <div class="setting-card-title">ğŸ§  æ™ºèƒ½æ¨è</div>
                <div class="setting-card-desc">FSRSç®—æ³•æ’åº</div>
              </div>
              <div class="setting-card ${currentSort === 'random' ? 'active' : ''}" onclick="app.selectSort('random')">
                <div class="setting-card-title">ğŸ² éšæœºé¡ºåº</div>
                <div class="setting-card-desc">æ‰“ä¹±é¡ºåº</div>
              </div>
              <div class="setting-card ${currentSort === 'added' ? 'active' : ''}" onclick="app.selectSort('added')">
                <div class="setting-card-title">ğŸ“ æ·»åŠ é¡ºåº</div>
                <div class="setting-card-desc">æŒ‰æ·»åŠ é¡ºåº</div>
              </div>
              <div class="setting-card ${currentSort === 'newFirst' ? 'active' : ''}" onclick="app.selectSort('newFirst')">
                <div class="setting-card-title">ğŸŒ± æ–°è¯ä¼˜å…ˆ</div>
                <div class="setting-card-desc">å¤ä¹ æ¬¡æ•°å°‘</div>
              </div>
              <div class="setting-card ${currentSort === 'errorFirst' ? 'active' : ''}" onclick="app.selectSort('errorFirst')">
                <div class="setting-card-title">âŒ é”™è¯¯ä¼˜å…ˆ</div>
                <div class="setting-card-desc">é—å¿˜æ¬¡æ•°å¤š</div>
              </div>
            </div>
            
            <div class="slider-container">
              <div class="slider-label">
                <span>3. ç»ƒä¹ æ•°é‡ (å¯é€‰: ${availableCount}ä¸ª)</span>
                <span class="slider-value">${currentQuantity}</span>
              </div>
              <input 
                type="range" 
                id="quantitySlider" 
                min="5" 
                max="100" 
                value="${currentQuantity}" 
                step="5"
                ${!canStart ? 'disabled' : ''}
              />
              ${isQuantityInvalid && canStart ? `
                <div class="warning-text">
                  âš ï¸ è­¦å‘Šï¼šæ‰€é€‰æ•°é‡ (${currentQuantity}) è¶…å‡ºå¯ç”¨å•è¯æ•° (${availableCount})ï¼Œå°†åªç»ƒä¹  ${availableCount} ä¸ªã€‚
                </div>
              ` : ''}
              ${!canStart ? `
                <div class="warning-text">
                  ğŸ¤·â€â™‚ï¸ å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å¯ç»ƒä¹ çš„å•è¯ã€‚
                </div>
              ` : ''}
            </div>

            <div class="button-group">
              <button class="btn-primary" id="startConfiguredPracticeBtn" ${!canStart ? 'disabled' : ''}>
                ğŸš€ å¼€å§‹ç»ƒä¹  (${Math.min(currentQuantity, availableCount)})
              </button>
              <button class="btn-secondary" id="backToLibraryBtn">
                â† è¿”å›è¯åº“
              </button>
            </div>
          </div>
        `;
      }

      renderWordList() {
        if (this.library.length === 0) {
          return `
            <div class="section">
              <h2 class="section-title">ğŸ“– å•è¯åˆ—è¡¨</h2>
              <div style="text-align: center; padding: 40px; color: #64748b;">
                æš‚æ— å•è¯ï¼Œè¯·å…ˆæ·»åŠ å•è¯åˆ°è¯åº“
              </div>
            </div>
          `;
        }
        
        // 1. æŒ‰dueæ—¶é—´æ’åº
        const sortedWords = [...this.library].sort((a, b) => a.due - b.due);
        
        // 2. æŒ‰æœç´¢è¯è¿‡æ»¤
        let filteredWords = sortedWords;
        if (this.searchTerm) {
          filteredWords = sortedWords.filter(w => 
            w.english.toLowerCase().includes(this.searchTerm) ||
            w.chinese.join('').toLowerCase().includes(this.searchTerm)
          );
        }
        
        const now = Date.now();

        return `
          <div class="section">
            <h2 class="section-title">ğŸ“– å•è¯åˆ—è¡¨ (${filteredWords.length}/${this.library.length})</h2>
            
            <input
              type="search"
              id="searchInput"
              value="${this.searchTerm}"
              placeholder="ğŸ” æœç´¢è‹±æ–‡æˆ–ä¸­æ–‡..."
            />
            
            <div class="word-list">
              ${filteredWords.map(word => {
                const difficultyLevel = this.fsrs.getDifficultyLevel(word.difficulty);
                const isDue = word.due <= now;
                const dueText = isDue 
                  ? 'éœ€è¦å¤ä¹ ' 
                  : `${Math.ceil((word.due - now) / (1000 * 60 * 60))}å°æ—¶å`;
                
                return `
                  <div class="word-item ${isDue ? 'is-due' : ''}" style="position: relative;">
                    <span 
                      class="word-star ${word.isStarred ? 'starred' : ''}"
                      onclick="app.toggleStar('${word.english}')"
                    >
                      ${word.isStarred ? 'â˜…' : 'â˜†'}
                    </span>
                    <div class="word-main">
                      <div class="word-english">${word.english}</div>
                      <div class="word-chinese">${word.chinese.join('ï¼Œ')}</div>
                    </div>
                    <div class="word-stats">
                      <span class="difficulty-badge difficulty-${difficultyLevel}">
                        ${difficultyLevel === 'easy' ? 'ç®€å•' : difficultyLevel === 'medium' ? 'ä¸­ç­‰' : 'å›°éš¾'}
                      </span>
                      <span>å¤ä¹ : ${word.reps}æ¬¡</span>
                      <span>é—å¿˜: ${word.lapses}æ¬¡</span>
                      <span style="color: ${isDue ? '#ef4444' : '#10b981'}; font-weight: 600;">${dueText}</span>
                      <button class="btn-secondary btn-small" onclick="app.resetWord('${word.english}')" style="padding: 8px 12px; font-size: 12px;">é‡ç½®</button>
                      <button class="btn-danger btn-small" onclick="app.deleteWord('${word.english}')" style="padding: 8px 12px; font-size: 12px;">åˆ é™¤</button>
                    </div>
                  </div>
                `;
              }).join('')}
              ${filteredWords.length === 0 ? `<div style="text-align: center; padding: 20px; color: #64748b;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å•è¯</div>` : ''}
            </div>
          </div>
        `;
      }

      renderModeSelect() {
        return `
          <div>
            <h2 class="section-title" style="text-align: center; margin-bottom: 40px;">é€‰æ‹©ç»ƒä¹ æ¨¡å¼</h2>
            <div class="mode-grid">
              <div class="mode-card" data-mode="1">
                <div class="mode-icon">ğŸ‡¬ğŸ‡§â†’ğŸ‡¨ğŸ‡³</div>
                <div class="mode-title">è‹±è¯‘ä¸­</div>
                <div class="mode-desc">çœ‹è‹±æ–‡å†™ä¸­æ–‡ç¿»è¯‘</div>
              </div>
              <div class="mode-card" data-mode="2">
                <div class="mode-icon">ğŸ‡¨ğŸ‡³â†’ğŸ‡¬ğŸ‡§</div>
                <div class="mode-title">ä¸­è¯‘è‹±</div>
                <div class="mode-desc">çœ‹ä¸­æ–‡å†™è‹±æ–‡å•è¯</div>
              </div>
              <div class="mode-card" data-mode="3">
                <div class="mode-icon">ğŸ§âœï¸</div>
                <div class="mode-title">å¬å†™æ¨¡å¼</div>
                <div class="mode-desc">å¬éŸ³é¢‘å†™å‡ºå•è¯å’Œç¿»è¯‘</div>
              </div>
            </div>
            <button class="btn-secondary" id="backToSettingsBtn" style="width: 100%;">
              â† è¿”å›ç»ƒä¹ è®¾ç½®
            </button>
          </div>
        `;
      }

      renderPractice() {
        const word = this.updatedWords[this.currentIndex];
        if (!word) {
          return '<div class="loading">åŠ è½½ä¸­...</div>';
        }

        const progress = ((this.currentIndex + 1) / this.updatedWords.length) * 100;
        
        let promptText = '';
        let placeholder = '';
        let showAudioBtn = false;
        let showPrompt = true;

        if (this.currentMode === 1) {
          promptText = word.english;
          placeholder = 'è¾“å…¥ä¸­æ–‡ç¿»è¯‘';
          showAudioBtn = true;
        } else if (this.currentMode === 2) {
          promptText = word.chinese.join('ï¼Œ');
          placeholder = 'è¾“å…¥è‹±æ–‡å•è¯';
        } else if (this.currentMode === 3) {
          placeholder = 'æ ¼å¼ï¼šè‹±æ–‡å•è¯ ä¸­æ–‡ç¿»è¯‘';
          showAudioBtn = true;
          showPrompt = false;
        }

        return `
          <div class="practice-container">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress}%"></div>
            </div>

            <div class="stats-row">
              <div class="stat-item">
                <div class="stat-item-label">è¿›åº¦</div>
                <div class="stat-item-value purple">${this.currentIndex + 1}/${this.updatedWords.length}</div>
              </div>
              <div class="stat-item">
                <div class="stat-item-label">æ­£ç¡®</div>
                <div class="stat-item-value green">${this.stats.correct}</div>
              </div>
              <div class="stat-item">
                <div class="stat-item-label">é”™è¯¯</div>
                <div class="stat-item-value red">${this.stats.incorrect}</div>
              </div>
            </div>

            <div class="question-card">
              ${showAudioBtn ? `
                <button class="audio-btn" id="playAudioBtn">
                  ğŸ”Š ${this.currentMode === 3 ? 'æ’­æ”¾å•è¯' : 'æ’­æ”¾å‘éŸ³'}
                </button>
              ` : ''}
              
              ${showPrompt ? `
                <div class="prompt-text">${promptText}</div>
              ` : `
                <div style="text-align: center; color: #64748b; font-size: 16px; margin: 20px 0;">
                  ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ’­æ”¾éŸ³é¢‘ï¼Œç„¶åè¾“å…¥ç­”æ¡ˆ
                </div>
              `}

              ${this.feedback ? `
                <div class="feedback ${this.feedback.type}">
                  ${this.feedback.text}
                </div>
              ` : ''}

              <input
                type="text"
                id="answerInput"
                value="${this.answer}"
                class="${this.feedback ? this.feedback.type : ''}"
                placeholder="${placeholder}"
                ${this.isAnswered ? 'disabled' : ''}
              />
              <div class="hint-text">ğŸ’¡ è¾“å…¥å®ŒæˆåæŒ‰å›è½¦é”®æäº¤</div>
            </div>

            <div class="button-group">
              <button class="btn-primary" id="checkAnswerBtn">
                ${this.isAnswered ? 'ä¸‹ä¸€é¢˜ â†’' : 'æ£€æŸ¥ç­”æ¡ˆ'}
              </button>
              ${!this.isAnswered ? `
                <button class="btn-secondary btn-small" id="skipBtn">è·³è¿‡</button>
              ` : ''}
            </div>
            
            <button class="btn-secondary" id="backToModeBtn" style="width: 100%; margin-top: 15px;">
              â† è¿”å›é€‰æ‹©æ¨¡å¼
            </button>
          </div>
        `;
      }

      renderComplete() {
        if (!this.finalStats) {
          return '<div class="loading">åŠ è½½ä¸­...</div>';
        }

        return `
          <div class="complete-container">
            <div class="complete-title">ğŸ‰ ç»ƒä¹ å®Œæˆï¼</div>
            
            <div class="complete-stats">
              <div class="complete-stat-card">
                <div class="complete-stat-value purple">${this.finalStats.total}</div>
                <div class="complete-stat-label">æ€»é¢˜æ•°</div>
              </div>
              <div class="complete-stat-card">
                <div class="complete-stat-value green">${this.finalStats.correct}</div>
                <div class="complete-stat-label">æ­£ç¡®æ•°</div>
              </div>
              <div class="complete-stat-card">
                <div class="complete-stat-value purple">${this.finalStats.accuracy}%</div>
                <div class="complete-stat-label">æ­£ç¡®ç‡</div>
              </div>
            </div>
            
            ${this.renderSmartHint()}

            ${this.renderLearningCurve()}

            <div class="button-group">
              <button class="btn-primary" id="continueBtn">ğŸ”„ ç»§ç»­å¤ä¹ </button>
              <button class="btn-secondary" id="backToLibraryCompleteBtn">ğŸ“š è¿”å›è¯åº“</button>
            </div>
          </div>
        `;
      }
      
      // æ–°å¢ï¼šæ¸²æŸ“æ™ºèƒ½æç¤º
      renderSmartHint() {
        const accuracy = this.finalStats.accuracy;
        const dueCount = this.getStats().due;
        let title = 'ğŸ’¡ æ™ºèƒ½å»ºè®®';
        let text = '';

        if (accuracy < 70 && this.finalStats.total > 0) {
          title = 'ğŸ¤” ä»éœ€åŠªåŠ›ï¼';
          text = `æœ¬æ¬¡æ­£ç¡®ç‡ï¼ˆ${accuracy}%ï¼‰æœ‰ç‚¹ä½å“¦ã€‚åˆ«ç°å¿ƒï¼Œè¢«æ ‡è®°ä¸ºâ€œé”™è¯¯â€çš„å•è¯ä¼šå¾ˆå¿«å†æ¬¡å‡ºç°ï¼Œå¤šç»ƒå‡ æ¬¡å°±è®°ä½äº†ï¼`;
        } else if (dueCount > 0) {
          title = 'ğŸ‘ åšå¾—ä¸é”™ï¼';
          text = `ä½ è¿˜æœ‰ <strong>${dueCount}</strong> ä¸ªå•è¯å¾…å¤ä¹ ã€‚ä¼‘æ¯ä¸€ä¸‹ï¼Œæˆ–ç‚¹å‡»â€œç»§ç»­å¤ä¹ â€æ¥æ¸…ç©ºå®ƒä»¬å§ï¼`;
        } else if (accuracy >= 95) {
          title = 'ğŸ‰ å¤ªæ£’äº†ï¼';
          text = 'ä½ å·²å®Œæˆæ‰€æœ‰å¤ä¹ ï¼Œå¹¶ä¸”ä¿æŒäº†éå¸¸é«˜çš„æ­£ç¡®ç‡ï¼æ˜å¤©å†æ¥å·©å›ºå§ã€‚';
        } else {
          title = 'ğŸ™Œ ç»ƒä¹ å®Œæˆï¼';
          text = 'æ‰€æœ‰åˆ°æœŸå•è¯éƒ½å·²å¤ä¹ å®Œæ¯•ï¼å»è¯åº“æ·»åŠ ä¸€äº›æ–°å•è¯ï¼Œæˆ–è€…ä¼‘æ¯ä¸€ä¸‹å§ã€‚';
        }

        return `
          <div class="smart-hint">
            <div class="smart-hint-title">${title}</div>
            <div class="smart-hint-text">${text}</div>
          </div>
        `;
      }

      renderLearningCurve() {
        // æ˜¾ç¤ºæœ¬æ¬¡ç»ƒä¹ çš„å•è¯å­¦ä¹ æ›²çº¿
        const words = this.updatedWords.slice(0, 10); // æœ€å¤šæ˜¾ç¤º10ä¸ª
        
        return `
          <div class="curve-chart">
            <div class="curve-title">ğŸ“Š æœ¬æ¬¡å­¦ä¹ è®°å½• (éƒ¨åˆ†)</div>
            ${words.map(word => {
              const difficultyLevel = this.fsrs.getDifficultyLevel(word.difficulty);
              return `
                <div class="curve-item">
                  <span class="curve-word">${word.english}</span>
                  <div class="curve-info">
                    <span class="difficulty-badge difficulty-${difficultyLevel}">
                      éš¾åº¦ ${word.difficulty.toFixed(1)}
                    </span>
                    <span>ç¨³å®šæ€§: ${word.stability.toFixed(1)}å¤©</span>
                    <span>é—´éš”: ${word.interval}å¤©</span>
                    <span>å¤ä¹ : ${word.reps}æ¬¡</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      // ==================== äº‹ä»¶ç›‘å¬ ====================
      
      attachEventListeners() {
        // è¯åº“é¡µé¢
        this.bindEvent('addWordsBtn', 'click', () => {
          const input = document.getElementById('wordInput');
          this.addWords(input.value);
        });

        this.bindEvent('startPracticeBtn', 'click', () => this.startPractice());
        this.bindEvent('quickStartNew', 'click', () => this.startQuickPractice('new'));
        this.bindEvent('quickStartStarred', 'click', () => this.startQuickPractice('starred'));
        this.bindEvent('exportBtn', 'click', () => this.exportLibrary());
        this.bindEvent('importBtn', 'click', () => this.importLibrary());
        this.bindEvent('clearBtn', 'click', () => this.clearLibrary());
        
        this.bindEvent('searchInput', 'input', (e) => {
          this.searchTerm = e.target.value.toLowerCase();
          this.render();
          document.getElementById('searchInput')?.focus(); // ä¿æŒç„¦ç‚¹
        });
        
        // ç»ƒä¹ è®¾ç½®é¡µé¢
        this.bindEvent('startConfiguredPracticeBtn', 'click', () => this.startConfiguredPractice());
        this.bindEvent('backToLibraryBtn', 'click', () => {
          this.stage = 'library';
          this.render();
        });
        this.bindEvent('quantitySlider', 'input', (e) => this.updateQuantity(e.target.value));

        // æ¨¡å¼é€‰æ‹©
        document.querySelectorAll('.mode-card').forEach(card => {
          card.onclick = () => this.selectMode(parseInt(card.dataset.mode));
        });
        
        this.bindEvent('backToSettingsBtn', 'click', () => {
          this.stage = 'settings';
          this.render();
        });

        // ç»ƒä¹ é¡µé¢
        const answerInput = document.getElementById('answerInput');
        if (answerInput) {
          answerInput.oninput = (e) => {
            this.answer = e.target.value;
          };
          answerInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
              e.preventDefault(); // é˜²æ­¢å›è½¦è§¦å‘è¡¨å•æäº¤ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
              this.checkAnswer(); // ç»Ÿä¸€è°ƒç”¨checkAnswerï¼Œå®ƒå†…éƒ¨å¤„ç†isAnswered
            }
          };
        }

        this.bindEvent('playAudioBtn', 'click', () => this.playAudio());
        this.bindEvent('checkAnswerBtn', 'click', () => this.checkAnswer());
        this.bindEvent('skipBtn', 'click', () => this.skipQuestion());
        this.bindEvent('backToModeBtn', 'click', () => {
          if (confirm('ç¡®å®šè¦é€€å‡ºå½“å‰ç»ƒä¹ å—ï¼Ÿè¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚')) {
            this.stage = 'mode';
            this.render();
          }
        });

        // å®Œæˆé¡µé¢
        this.bindEvent('continueBtn', 'click', () => this.startPractice()); // æ”¹ä¸ºè¿”å›è®¾ç½®é¡µé¢
        this.bindEvent('backToLibraryCompleteBtn', 'click', () => {
          this.stage = 'library';
          this.render();
        });
      }

      bindEvent(id, eventType, handler) {
        const element = document.getElementById(id);
        if (element) {
          element['on' + eventType] = handler;
        }
      }
    }

    // å¯åŠ¨åº”ç”¨
    let app;
    window.addEventListener('DOMContentLoaded', () => {
      app = new VocabularyApp();
      window.app = app; // æš´éœ²åˆ°å…¨å±€ä»¥ä¾¿å†…è”äº‹ä»¶è°ƒç”¨
    });
  </script>
</body>
</html>